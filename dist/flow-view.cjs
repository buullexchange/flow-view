"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var n=require("classnames"),e=require("react"),t=require("zustand");function r(n){return n&&"object"==typeof n&&"default"in n?n:{default:n}}var o=r(n),i=r(e),u=r(t);function a(n){return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(n){return typeof n}:function(n){return n&&"function"==typeof Symbol&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n})(n)}function c(n,e,t){return e in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function d(){return(d=Object.assign||function(n){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(n[r]=t[r])}return n}).apply(this,arguments)}function f(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),t.push.apply(t,r)}return t}function s(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?f(Object(t),!0).forEach((function(e){c(n,e,t[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):f(Object(t)).forEach((function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(t,e))}))}return n}function l(n,e){if(null==n)return{};var t,r,o=function(n,e){if(null==n)return{};var t,r,o={},i=Object.keys(n);for(r=0;r<i.length;r++)t=i[r],e.indexOf(t)>=0||(o[t]=n[t]);return o}(n,e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);for(r=0;r<i.length;r++)t=i[r],e.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(n,t)&&(o[t]=n[t])}return o}function p(n,e){return function(n){if(Array.isArray(n))return n}(n)||function(n,e){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(n)))return;var t=[],r=!0,o=!1,i=void 0;try{for(var u,a=n[Symbol.iterator]();!(r=(u=a.next()).done)&&(t.push(u.value),!e||t.length!==e);r=!0);}catch(n){o=!0,i=n}finally{try{r||null==a.return||a.return()}finally{if(o)throw i}}return t}(n,e)||function(n,e){if(!n)return;if("string"==typeof n)return v(n,e);var t=Object.prototype.toString.call(n).slice(8,-1);"Object"===t&&n.constructor&&(t=n.constructor.name);if("Map"===t||"Set"===t)return Array.from(n);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return v(n,e)}(n,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function v(n,e){(null==e||e>n.length)&&(e=n.length);for(var t=0,r=new Array(e);t<e;t++)r[t]=n[t];return r}var m={width:0,height:0},y={x:0,y:0},g="input",w="output",h=function(n){return n.id},b=function(n){return n.selected},P=function(n){return function(e){return e.nodes.find((function(e){return e.id===n}))}},I=function(n){return function(e){return 0===n?e.nodes.filter((function(n){var e=n.id,t=n.containerId;return 0!==e&&(0===t||void 0===t)})):e.nodes.filter((function(e){var t=e.containerId;return n===t}))}},x=function n(e){return function(t){return I(e)(t).reduce((function(e,r){return e.concat(r).concat(n(r.id)(t))}),[])}},S=function(n,e){return function(t){return t.pipes.find((function(t){var r=p(t.target,2),o=r[0],i=r[1];return n===o&&e===i}))}},O=function(n){return function(e){if(0===n)return[];var t=P(n)(e);return t.inputs.map((function(t,r){return S(n,r)(e)})).map((function(r,o){return void 0===r?t.inputs[o].data:function(n,e){return function(t){var r=S(n,e)(t);if(r){var o=p(r.source,2),i=o[0],u=o[1];return P(i)(t).outputs[u]}}}(n,o)(e).data}))}},E=function(n){return function(n){return n.nodes.filter(b)}(n).map(h)},j=function(n){return function(e){var t;return 0===n||!0===(null===(t=P(n)(e))||void 0===t?void 0:t.isContainer)}};function C(n){var e=n.id,t=n.useStore,r=n.width,o=n.height,u=t(I(e)),a=t(function(n){return function(e){return e.pipes.filter((function(e){var t=e.containerId;return 0===n?0===t||void 0===t:n===t}))}}(e));return i.default.createElement(i.default.Fragment,null,u.map((function(n,e){return i.default.createElement(N,d({key:e,useStore:t},n))})),i.default.createElement("svg",{width:r,height:o,viewBox:"0 0 ".concat(r," ").concat(o)},a.map((function(n,e){return i.default.createElement(k,d({key:e,useStore:t},n))}))))}function N(n){var t,r=n.id,u=void 0===r?0:r,c=n.containerId,f=void 0===c?0:c,l=n.label,v=n.comment,y=n.useStore,g=n.error,w=0===u,I=p(e.useState(0),2),S=I[0],N=I[1],_=p(e.useState(0),2),M=_[0],k=_[1],A=e.useRef(),T=e.useRef(),R=y(P(u)),H=R.dimension,V=void 0===H?m:H,z=R.position,q=R.inputs,B=void 0===q?[]:q,G=R.noFootbar,L=R.noHeadbar,W=R.outputs,U=void 0===W?[]:W,X=R.selected,Y=V.width,$=V.height,J=y((t=u,function(n){return x(t)(n).map(h)})),K=y((function(n){return n.focusedPinData})),Q=y((function(n){return n.focusedPinNodeId})),Z=y((function(n){return n.focusedPinTypes})),nn=y(O(u)),en=y(j(u)),tn=y(function(n){return function(e){var t=P(n)(e).Component,r="function"==typeof t,o=j(n)(e);switch(!0){case r:return function(n){return i.default.createElement(t,n)};case o:return function(n){return i.default.createElement(C,n)};default:return function(){return null}}}}(u)),rn=y(E),on=y((function(n){return n.setSelectedNodes})),un=y((function(n){return n.setStartDraggingPoint})),an=y(function(n){return function(e){return x(n)(e).some(b)}}(u)),cn=y((function(n){return n.startDraggingPoint})),dn=y((function(n){return n.translateNodes}));return e.useEffect((function(){if(T.current){var n=T.current.getBoundingClientRect().height;k(u,n)}}),[u,T,k]),e.useEffect((function(){if(A.current){var n=A.current.getBoundingClientRect().height;N(u,n)}}),[u,A,N]),i.default.createElement(i.default.Fragment,null,i.default.createElement("div",{className:o.default("flow-view-node",{"flow-view-node--has-error":"string"==typeof g,"flow-view-node--selected":X}),onClick:function(n){n.stopPropagation()},onMouseDown:function(n){n.stopPropagation(),un({x:n.clientX,y:n.clientY}),w?on(J,!1):(on(rn,!1),on([u],!0))},onMouseMove:function(n){if(en&&(n.stopPropagation(),cn)){var e=n.clientX,t=n.clientY;dn(rn,{x:e-cn.x,y:t-cn.y}),un({x:e,y:t})}},onMouseUp:function(n){n.stopPropagation(),un()},style:s(s({},V),{},{top:null==z?void 0:z.y,left:null==z?void 0:z.x})},L||i.default.createElement("div",{ref:T,className:"flow-view-node__headbar"},B.map((function(n,e){return i.default.createElement(F,d({key:e,data:nn[e],containerId:f,nodeId:u,index:e,useStore:y},n))}))),i.default.createElement("div",{className:"flow-view-node__body",onMouseDown:function(n){w||en&&(X||(n.stopPropagation(),an&&on(J,!1)))},onMouseLeave:function(){en&&un()}},tn({id:u,containerId:f,inputs:B.map((function(n,e){return s(s({},n),{},{data:nn[e]})})),outputs:U,label:l,comment:v,selected:X,error:g,useStore:y,width:Y,height:$-M-S})),G||i.default.createElement("div",{ref:A,className:"flow-view-node__footbar"},U.map((function(n,e){return i.default.createElement(D,d({key:e,containerId:f,nodeId:u,index:e,useStore:y},n))})))),Q===u&&i.default.createElement("div",{className:"flow-view-node__pin-preview",style:{left:z.x+V.width+10,top:z.y}},i.default.createElement("div",{className:"flow-view-node__pin-preview-types"},Array.isArray(Z)?Z.join():"any"),i.default.createElement("div",{className:"flow-view-node__pin-preview-data"},function(n){var e=a(n);switch(!0){case["undefined","symbol","function"].includes(e):return e;default:return String(n)}}(K))))}function _(n){var e=n.containerId,t=n.data,r=(n.index,n.nodeId),u=n.pinClass,a=n.types,c=n.useStore,d=c((function(n){return n.setFocusedPinClass})),f=c((function(n){return n.setFocusedPinData})),s=c((function(n){return n.setFocusedPinContainerId})),l=c((function(n){return n.setFocusedPinNodeId})),p=c((function(n){return n.setFocusedPinTypes})),v=c((function(n){return n.focusedPinClass})),m=c((function(n){return n.focusedPinContainerId})),y=c((function(n){return n.focusedPinNodeId})),g=c((function(n){return n.focusedPinTypes})),w=void 0!==m&&e===m,h=void 0!==y&&r!==y,b=a.some((function(n){return g.includes(n)}))&&("string"==typeof v&&v!==u)&&w&&h;return i.default.createElement("div",{className:o.default("flow-view-pin",{"flow-view-pin--highlighted":b}),onClick:function(n){n.stopPropagation()},onMouseDown:function(n){n.stopPropagation()},onMouseEnter:function(){d(u),f(t),s(e),l(r),p(a)},onMouseLeave:function(){d(),f(),l(),p()}})}function F(n){return i.default.createElement(_,d({pinClass:g},n))}function D(n){return i.default.createElement(_,d({pinClass:w},n))}var M=function(n){var e=n.pinSize,t=n.nodeHeight,r=n.nodeWidth,o=n.numPins,i=n.pinClass,u=n.pinIndex;return{x:0===u?0:u*(r-e)/(o-1),y:i===g?0:t-e}};function k(n){var e=n.source,t=n.target,r=n.useStore,o=p(e,2),u=o[0],a=o[1],c=p(t,2),d=c[0],f=c[1],s=r(P(u)),l=s.dimension,v=s.position,m=s.outputs,y=void 0===m?[]:m,h=r(P(d)),b=h.dimension,I=h.position,x=h.inputs,S=void 0===x?[]:x,O=M({pinSize:10,nodeHeight:l.height,nodeWidth:l.width,numPins:y.length,pinClass:w,pinIndex:a}),E=M({pinSize:10,nodeHeight:b.height,nodeWidth:b.width,numPins:S.length,pinClass:g,pinIndex:f});if(void 0===O||void 0===E)return null;var j=v.x+O.x+1+5,C=v.y+O.y+1+5,N=I.x+E.x+1+5,_=I.y+E.y+1+5;return i.default.createElement("line",{className:"flow-view-pipe",x1:j,y1:C,x2:N,y2:_})}exports.FlowViewNode=N,exports.FlowViewNodeLabel=function(n){var e=n.label,t=n.comment,r=n.onClick;return i.default.createElement("div",{className:o.default("flow-view-node__label",{"flow-view-node__label--has-comment":t}),onClick:r},i.default.createElement("span",null,e),t&&i.default.createElement("span",{className:"flow-view-node__comment"},t))},exports.createFlowViewStore=function(){return u.default((function(n,e){return{iteration:0,nextId:1,focusedPinTypes:[],nodes:[{id:0,containerId:0,isContainer:!0,dimension:m,position:y,noFootbar:!0,noHeadbar:!0}],pipes:[],updateGraph:function(e){var t=e.next,r=e.nodes,o=void 0===r?[]:r,i=e.pipes,u=void 0===i?[]:i;n((function(n){return{iteration:t?n.iteration+1:n.iteration,nodes:n.nodes.map((function(n){var e=n.id,t=l(n,["id"]),r=o.find((function(n){var t=n.id;return e===t}));return r?s(s({id:e},t),r):s({id:e},t)})),pipes:n.pipes.map((function(n){var e=n.containerId,t=n.id,r=l(n,["containerId","id"]),o=u.find((function(n){var e=n.containerId,r=n.id;return t===r&&e===r}));return o?s(s({id:t,containerId:e},r),o):s({containerId:e,id:t},r)}))}}))},appendGraph:function(t){var r=t.next,o=t.nodes,i=void 0===o?[]:o,u=t.pipes,a=void 0===u?[]:u,c=e().nextId,d=new Map;d.set(0,0),i.concat(a).forEach((function(n){var e=n.containerId,t=n.id;d.has(e)||d.set(e,c++),d.has(t)||d.set(t,c++)})),n((function(n){return{iteration:r?n.iteration+1:n.iteration,nextId:c,nodes:n.nodes.concat(i.map((function(n){var e=n.containerId,t=n.id,r=l(n,["containerId","id"]);return s({containerId:d.get(e),id:d.get(t)},r)}))),pipes:n.pipes.concat(a.map((function(n){var e=n.containerId,t=n.id,r=p(n.source,2),o=r[0],i=r[1],u=p(n.target,2),a=u[0],c=u[1],f=l(n,["containerId","id","source","target"]);return s({containerId:d.get(e),id:d.get(t),source:[d.get(o),i],target:[d.get(a),c]},f)})))}}))},setFocusedPinClass:function(e){n((function(n){return{focusedPinClass:e}}))},setFocusedPinData:function(e){n((function(n){return{focusedPinData:e}}))},setFocusedPinNodeId:function(e){n((function(n){return{focusedPinNodeId:e}}))},setFocusedPinContainerId:function(e){n((function(n){return{focusedPinContainerId:e}}))},setFocusedPinTypes:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return n((function(n){return{focusedPinTypes:e}}))},setRootDimension:function(e){n((function(n){return{nodes:n.nodes.map((function(n){var t=n.id,r=l(n,["id"]);return 0===t?s(s({},r),{},{id:t,dimension:e}):s({id:t},r)}))}}))},setRootPosition:function(e){n((function(n){return{nodes:n.nodes.map((function(n){var t=n.id,r=l(n,["id"]);return 0===t?s(s({},r),{},{id:t,position:e}):s({id:t},r)}))}}))},setSelectedNodes:function(e,t){n((function(n){return{nodes:n.nodes.filter((function(n){var t=n.id;return!e.includes(t)})).map((function(n){n.selected;return l(n,["selected"])})).concat(n.nodes.filter((function(n){var t=n.id;return e.includes(t)})).map((function(n){return s(s({},n),{},{selected:t})})))}}))},setStartDraggingPoint:function(e){n((function(n){return{startDraggingPoint:e}}))},translateNodes:function(e,t){n((function(n){return{nodes:n.nodes.map((function(n){var r=n.id,o=n.position,i=l(n,["id","position"]);return e.includes(r)?s(s({},i),{},{id:r,position:{x:Math.max(0,o.x+t.x),y:Math.max(0,o.y+t.y)}}):s(s({},i),{},{id:r,position:o})}))}}))}}}))},exports.flowViewGraphIsValid=function(){return!0};
