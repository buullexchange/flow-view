import n from"classnames";import e,{useState as t,useRef as r,useEffect as o}from"react";import i from"zustand";function u(n){return(u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(n){return typeof n}:function(n){return n&&"function"==typeof Symbol&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n})(n)}function c(n,e,t){return e in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function a(){return(a=Object.assign||function(n){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(n[r]=t[r])}return n}).apply(this,arguments)}function s(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),t.push.apply(t,r)}return t}function d(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?s(Object(t),!0).forEach((function(e){c(n,e,t[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):s(Object(t)).forEach((function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(t,e))}))}return n}function f(n,e){if(null==n)return{};var t,r,o=function(n,e){if(null==n)return{};var t,r,o={},i=Object.keys(n);for(r=0;r<i.length;r++)t=i[r],e.indexOf(t)>=0||(o[t]=n[t]);return o}(n,e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);for(r=0;r<i.length;r++)t=i[r],e.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(n,t)&&(o[t]=n[t])}return o}function l(n,e){return function(n){if(Array.isArray(n))return n}(n)||function(n,e){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(n)))return;var t=[],r=!0,o=!1,i=void 0;try{for(var u,c=n[Symbol.iterator]();!(r=(u=c.next()).done)&&(t.push(u.value),!e||t.length!==e);r=!0);}catch(n){o=!0,i=n}finally{try{r||null==c.return||c.return()}finally{if(o)throw i}}return t}(n,e)||function(n,e){if(!n)return;if("string"==typeof n)return p(n,e);var t=Object.prototype.toString.call(n).slice(8,-1);"Object"===t&&n.constructor&&(t=n.constructor.name);if("Map"===t||"Set"===t)return Array.from(n);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return p(n,e)}(n,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function p(n,e){(null==e||e>n.length)&&(e=n.length);for(var t=0,r=new Array(e);t<e;t++)r[t]=n[t];return r}var v={width:0,height:0},m={x:0,y:0},y="input",g="output",h=function(n){return n.id},w=function(n){return n.selected},b=function(n){return function(e){return e.nodes.find((function(e){return e.id===n}))}},P=function(n){return function(e){return 0===n?e.nodes.filter((function(n){var e=n.id,t=n.containerId;return 0!==e&&(0===t||void 0===t)})):e.nodes.filter((function(e){var t=e.containerId;return n===t}))}},I=function n(e){return function(t){return P(e)(t).reduce((function(e,r){return e.concat(r).concat(n(r.id)(t))}),[])}},x=function(n,e){return function(t){return t.pipes.find((function(t){var r=l(t.target,2),o=r[0],i=r[1];return n===o&&e===i}))}},O=function(n){return function(e){if(0===n)return[];var t=b(n)(e);return t.inputs.map((function(t,r){return x(n,r)(e)})).map((function(r,o){return void 0===r?t.inputs[o].data:function(n,e){return function(t){var r=x(n,e)(t);if(r){var o=l(r.source,2),i=o[0],u=o[1];return b(i)(t).outputs[u]}}}(n,o)(e).data}))}},S=function(n){return function(n){return n.nodes.filter(w)}(n).map(h)},E=function(n){return function(e){var t;return 0===n||!0===(null===(t=b(n)(e))||void 0===t?void 0:t.isContainer)}};function C(n){var t=n.id,r=n.useStore,o=n.width,i=n.height,u=r(P(t)),c=r(function(n){return function(e){return e.pipes.filter((function(e){var t=e.containerId;return 0===n?0===t||void 0===t:n===t}))}}(t));return e.createElement(e.Fragment,null,u.map((function(n,t){return e.createElement(D,a({key:t,useStore:r},n))})),e.createElement("svg",{width:o,height:i,viewBox:"0 0 ".concat(o," ").concat(i)},c.map((function(n,t){return e.createElement(T,a({key:t,useStore:r},n))}))))}function j(t){var r=t.label,o=t.comment,i=t.onClick;return e.createElement("div",{className:n("flow-view-node__label",{"flow-view-node__label--has-comment":o}),onClick:i},e.createElement("span",null,r),o&&e.createElement("span",{className:"flow-view-node__comment"},o))}function N(){return!0}var _=function(){return i((function(n,e){return{iteration:0,nextId:1,focusedPinTypes:[],nodes:[{id:0,containerId:0,isContainer:!0,dimension:v,position:m,noFootbar:!0,noHeadbar:!0}],pipes:[],updateGraph:function(e){var t=e.next,r=e.nodes,o=void 0===r?[]:r,i=e.pipes,u=void 0===i?[]:i;n((function(n){return{iteration:t?n.iteration+1:n.iteration,nodes:n.nodes.map((function(n){var e=n.id,t=f(n,["id"]),r=o.find((function(n){var t=n.id;return e===t}));return r?d(d({id:e},t),r):d({id:e},t)})),pipes:n.pipes.map((function(n){var e=n.containerId,t=n.id,r=f(n,["containerId","id"]),o=u.find((function(n){var e=n.containerId,r=n.id;return t===r&&e===r}));return o?d(d({id:t,containerId:e},r),o):d({containerId:e,id:t},r)}))}}))},appendGraph:function(t){var r=t.next,o=t.nodes,i=void 0===o?[]:o,u=t.pipes,c=void 0===u?[]:u,a=e().nextId,s=new Map;s.set(0,0),i.concat(c).forEach((function(n){var e=n.containerId,t=n.id;s.has(e)||s.set(e,a++),s.has(t)||s.set(t,a++)})),n((function(n){return{iteration:r?n.iteration+1:n.iteration,nextId:a,nodes:n.nodes.concat(i.map((function(n){var e=n.containerId,t=n.id,r=f(n,["containerId","id"]);return d({containerId:s.get(e),id:s.get(t)},r)}))),pipes:n.pipes.concat(c.map((function(n){var e=n.containerId,t=n.id,r=l(n.source,2),o=r[0],i=r[1],u=l(n.target,2),c=u[0],a=u[1],p=f(n,["containerId","id","source","target"]);return d({containerId:s.get(e),id:s.get(t),source:[s.get(o),i],target:[s.get(c),a]},p)})))}}))},setFocusedPinClass:function(e){n((function(n){return{focusedPinClass:e}}))},setFocusedPinData:function(e){n((function(n){return{focusedPinData:e}}))},setFocusedPinNodeId:function(e){n((function(n){return{focusedPinNodeId:e}}))},setFocusedPinContainerId:function(e){n((function(n){return{focusedPinContainerId:e}}))},setFocusedPinTypes:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return n((function(n){return{focusedPinTypes:e}}))},setRootDimension:function(e){n((function(n){return{nodes:n.nodes.map((function(n){var t=n.id,r=f(n,["id"]);return 0===t?d(d({},r),{},{id:t,dimension:e}):d({id:t},r)}))}}))},setRootPosition:function(e){n((function(n){return{nodes:n.nodes.map((function(n){var t=n.id,r=f(n,["id"]);return 0===t?d(d({},r),{},{id:t,position:e}):d({id:t},r)}))}}))},setSelectedNodes:function(e,t){n((function(n){return{nodes:n.nodes.filter((function(n){var t=n.id;return!e.includes(t)})).map((function(n){n.selected;return f(n,["selected"])})).concat(n.nodes.filter((function(n){var t=n.id;return e.includes(t)})).map((function(n){return d(d({},n),{},{selected:t})})))}}))},setStartDraggingPoint:function(e){n((function(n){return{startDraggingPoint:e}}))},translateNodes:function(e,t){n((function(n){return{nodes:n.nodes.map((function(n){var r=n.id,o=n.position,i=f(n,["id","position"]);return e.includes(r)?d(d({},i),{},{id:r,position:{x:Math.max(0,o.x+t.x),y:Math.max(0,o.y+t.y)}}):d(d({},i),{},{id:r,position:o})}))}}))}}}))};function D(i){var c,s=i.id,f=void 0===s?0:s,p=i.containerId,m=void 0===p?0:p,y=i.label,g=i.comment,P=i.useStore,x=i.error,j=0===f,N=l(t(0),2),_=N[0],D=N[1],F=l(t(0),2),A=F[0],T=F[1],H=r(),z=r(),R=P(b(f)),B=R.dimension,W=void 0===B?v:B,G=R.position,L=R.inputs,U=void 0===L?[]:L,X=R.noFootbar,Y=R.noHeadbar,$=R.outputs,q=void 0===$?[]:$,J=R.selected,K=W.width,Q=W.height,V=P((c=f,function(n){return I(c)(n).map(h)})),Z=P((function(n){return n.focusedPinData})),nn=P((function(n){return n.focusedPinNodeId})),en=P((function(n){return n.focusedPinTypes})),tn=P(O(f)),rn=P(E(f)),on=P(function(n){return function(t){var r=b(n)(t).Component,o="function"==typeof r,i=E(n)(t);switch(!0){case o:return function(n){return e.createElement(r,n)};case i:return function(n){return e.createElement(C,n)};default:return function(){return null}}}}(f)),un=P(S),cn=P((function(n){return n.setSelectedNodes})),an=P((function(n){return n.setStartDraggingPoint})),sn=P(function(n){return function(e){return I(n)(e).some(w)}}(f)),dn=P((function(n){return n.startDraggingPoint})),fn=P((function(n){return n.translateNodes}));return o((function(){if(z.current){var n=z.current.getBoundingClientRect().height;T(f,n)}}),[f,z,T]),o((function(){if(H.current){var n=H.current.getBoundingClientRect().height;D(f,n)}}),[f,H,D]),e.createElement(e.Fragment,null,e.createElement("div",{className:n("flow-view-node",{"flow-view-node--has-error":"string"==typeof x,"flow-view-node--selected":J}),onClick:function(n){n.stopPropagation()},onMouseDown:function(n){n.stopPropagation(),an({x:n.clientX,y:n.clientY}),j?cn(V,!1):(cn(un,!1),cn([f],!0))},onMouseMove:function(n){if(rn&&(n.stopPropagation(),dn)){var e=n.clientX,t=n.clientY;fn(un,{x:e-dn.x,y:t-dn.y}),an({x:e,y:t})}},onMouseUp:function(n){n.stopPropagation(),an()},style:d(d({},W),{},{top:null==G?void 0:G.y,left:null==G?void 0:G.x})},Y||e.createElement("div",{ref:z,className:"flow-view-node__headbar"},U.map((function(n,t){return e.createElement(M,a({key:t,data:tn[t],containerId:m,nodeId:f,index:t,useStore:P},n))}))),e.createElement("div",{className:"flow-view-node__body",onMouseDown:function(n){j||rn&&(J||(n.stopPropagation(),sn&&cn(V,!1)))},onMouseLeave:function(){rn&&an()}},on({id:f,containerId:m,inputs:U.map((function(n,e){return d(d({},n),{},{data:tn[e]})})),outputs:q,label:y,comment:g,selected:J,error:x,useStore:P,width:K,height:Q-A-_})),X||e.createElement("div",{ref:H,className:"flow-view-node__footbar"},q.map((function(n,t){return e.createElement(k,a({key:t,containerId:m,nodeId:f,index:t,useStore:P},n))})))),nn===f&&e.createElement("div",{className:"flow-view-node__pin-preview",style:{left:G.x+W.width+10,top:G.y}},e.createElement("div",{className:"flow-view-node__pin-preview-types"},Array.isArray(en)?en.join():"any"),e.createElement("div",{className:"flow-view-node__pin-preview-data"},function(n){var e=u(n);switch(!0){case["undefined","symbol","function"].includes(e):return e;default:return String(n)}}(Z))))}function F(t){var r=t.containerId,o=t.data,i=(t.index,t.nodeId),u=t.pinClass,c=t.types,a=t.useStore,s=a((function(n){return n.setFocusedPinClass})),d=a((function(n){return n.setFocusedPinData})),f=a((function(n){return n.setFocusedPinContainerId})),l=a((function(n){return n.setFocusedPinNodeId})),p=a((function(n){return n.setFocusedPinTypes})),v=a((function(n){return n.focusedPinClass})),m=a((function(n){return n.focusedPinContainerId})),y=a((function(n){return n.focusedPinNodeId})),g=a((function(n){return n.focusedPinTypes})),h=void 0!==m&&r===m,w=void 0!==y&&i!==y,b=c.some((function(n){return g.includes(n)}))&&("string"==typeof v&&v!==u)&&h&&w;return e.createElement("div",{className:n("flow-view-pin",{"flow-view-pin--highlighted":b}),onClick:function(n){n.stopPropagation()},onMouseDown:function(n){n.stopPropagation()},onMouseEnter:function(){s(u),d(o),f(r),l(i),p(c)},onMouseLeave:function(){s(),d(),l(),p()}})}function M(n){return e.createElement(F,a({pinClass:y},n))}function k(n){return e.createElement(F,a({pinClass:g},n))}var A=function(n){var e=n.pinSize,t=n.nodeHeight,r=n.nodeWidth,o=n.numPins,i=n.pinClass,u=n.pinIndex;return{x:0===u?0:u*(r-e)/(o-1),y:i===y?0:t-e}};function T(n){var t=n.source,r=n.target,o=n.useStore,i=l(t,2),u=i[0],c=i[1],a=l(r,2),s=a[0],d=a[1],f=o(b(u)),p=f.dimension,v=f.position,m=f.outputs,h=void 0===m?[]:m,w=o(b(s)),P=w.dimension,I=w.position,x=w.inputs,O=void 0===x?[]:x,S=A({pinSize:10,nodeHeight:p.height,nodeWidth:p.width,numPins:h.length,pinClass:g,pinIndex:c}),E=A({pinSize:10,nodeHeight:P.height,nodeWidth:P.width,numPins:O.length,pinClass:y,pinIndex:d});if(void 0===S||void 0===E)return null;var C=v.x+S.x+1+5,j=v.y+S.y+1+5,N=I.x+E.x+1+5,_=I.y+E.y+1+5;return e.createElement("line",{className:"flow-view-pipe",x1:C,y1:j,x2:N,y2:_})}export{D as FlowViewNode,j as FlowViewNodeLabel,_ as createFlowViewStore,N as flowViewGraphIsValid};
